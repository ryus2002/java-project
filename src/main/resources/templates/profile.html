<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/default :: html(~{::title}, ~{::main}, ~{::link}, ~{::script})}">
<head>
    <title>個人資料 - 電商系統</title>
    <link rel="stylesheet" href=""> <!-- 額外的CSS -->
</head>
<body>
    <main>
        <div class="row">
            <!-- 左側選單 -->
            <div class="col-md-3 mb-4">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-person-circle"></i> 會員中心</h5>
                    </div>
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action active">
                            <i class="bi bi-person"></i> 個人資料
                        </a>
                        <a th:href="@{/orders}" class="list-group-item list-group-item-action">
                            <i class="bi bi-receipt"></i> 訂單記錄
                        </a>
                        <a th:href="@{/cart}" class="list-group-item list-group-item-action">
                            <i class="bi bi-cart"></i> 購物車
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                            <i class="bi bi-key"></i> 修改密碼
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- 右側內容 -->
            <div class="col-md-9">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-person"></i> 個人資料</h5>
                    </div>
                    <div class="card-body">
                        <!-- 成功訊息 -->
                        <div id="successMessage" class="alert alert-success d-none" role="alert">
                            <i class="bi bi-check-circle-fill"></i> <span id="successText">個人資料更新成功！</span>
                        </div>
                        
                        <!-- 錯誤訊息 -->
                        <div id="errorMessage" class="alert alert-danger d-none" role="alert">
                            <i class="bi bi-exclamation-triangle-fill"></i> <span id="errorText">更新失敗，請稍後再試。</span>
                        </div>
                        
                        <!-- 個人資料表單 -->
                        <form id="profileForm">
                            <!-- 用戶名 (唯讀) -->
                            <div class="mb-3 row">
                                <label for="username" class="col-sm-3 col-form-label">用戶名</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control-plaintext" id="username" readonly>
                                </div>
                            </div>
                            
                            <!-- 電子郵件 -->
                            <div class="mb-3 row">
                                <label for="email" class="col-sm-3 col-form-label">電子郵件 <span class="text-danger">*</span></label>
                                <div class="col-sm-9">
                                    <input type="email" class="form-control" id="email" required>
                                    <div class="form-text">更改電子郵件後，系統將發送驗證郵件到新地址</div>
                                </div>
                            </div>
                            
                            <!-- 暱稱 -->
                            <div class="mb-3 row">
                                <label for="nickname" class="col-sm-3 col-form-label">暱稱</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="nickname" maxlength="50">
                                    <div class="form-text">暱稱將顯示在您的個人資料頁面</div>
                                </div>
                            </div>
                            
                            <!-- 星座 -->
                            <div class="mb-3 row">
                                <label for="zodiacSign" class="col-sm-3 col-form-label">星座</label>
                                <div class="col-sm-9">
                                    <select class="form-select" id="zodiacSign">
                                        <option value="">請選擇您的星座（選填）</option>
                                        <option value="水瓶座">水瓶座 (1月20日-2月18日)</option>
                                        <option value="雙魚座">雙魚座 (2月19日-3月20日)</option>
                                        <option value="牡羊座">牡羊座 (3月21日-4月19日)</option>
                                        <option value="金牛座">金牛座 (4月20日-5月20日)</option>
                                        <option value="雙子座">雙子座 (5月21日-6月21日)</option>
                                        <option value="巨蟹座">巨蟹座 (6月22日-7月22日)</option>
                                        <option value="獅子座">獅子座 (7月23日-8月22日)</option>
                                        <option value="處女座">處女座 (8月23日-9月22日)</option>
                                        <option value="天秤座">天秤座 (9月23日-10月23日)</option>
                                        <option value="天蠍座">天蠍座 (10月24日-11月22日)</option>
                                        <option value="射手座">射手座 (11月23日-12月21日)</option>
                                        <option value="摩羯座">摩羯座 (12月22日-1月19日)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- 註冊時間 (唯讀) -->
                            <div class="mb-3 row">
                                <label for="createdAt" class="col-sm-3 col-form-label">註冊時間</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control-plaintext" id="createdAt" readonly>
                                </div>
                            </div>
                            
                            <!-- 提交按鈕 -->
                            <div class="mb-3 row">
                                <div class="col-sm-9 offset-sm-3">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save"></i> 保存修改
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 修改密碼模態框 -->
        <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="changePasswordModalLabel"><i class="bi bi-key"></i> 修改密碼</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- 密碼修改錯誤訊息 -->
                        <div id="passwordErrorMessage" class="alert alert-danger d-none" role="alert">
                            <i class="bi bi-exclamation-triangle-fill"></i> <span id="passwordErrorText">密碼修改失敗</span>
                        </div>
                        
                        <!-- 密碼修改表單 -->
                        <form id="changePasswordForm">
                            <!-- 當前密碼 -->
                            <div class="mb-3">
                                <label for="currentPassword" class="form-label">當前密碼 <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-key"></i></span>
                                    <input type="password" class="form-control" id="currentPassword" required>
                                    <button class="btn btn-outline-secondary" type="button" id="toggleCurrentPassword">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 新密碼 -->
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">新密碼 <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
                                    <input type="password" class="form-control" id="newPassword" 
                                           required minlength="8" maxlength="120">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <div class="form-text">密碼應包含大小寫字母、數字和特殊字符，長度至少8個字符</div>
                            </div>
                            
                            <!-- 確認新密碼 -->
                            <div class="mb-3">
                                <label for="confirmNewPassword" class="form-label">確認新密碼 <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
                                    <input type="password" class="form-control" id="confirmNewPassword" 
                                           required minlength="8" maxlength="120">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleConfirmNewPassword">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <div class="form-text">請確保兩次輸入的新密碼一致</div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="savePasswordButton">
                            <i class="bi bi-save"></i> 保存修改
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 獲取用戶資料
            function loadUserProfile() {
                // 從localStorage獲取JWT令牌
                const token = localStorage.getItem('token');
                
                if (!token) {
                    // 未登入，重定向到登入頁面
                    window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                // 獲取當前用戶資料
                fetch('/api/users/me', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('獲取用戶資料失敗');
                    }
                    return response.json();
                })
                .then(data => {
                    // 填充表單
                    document.getElementById('username').value = data.username;
                    document.getElementById('email').value = data.email;
                    document.getElementById('nickname').value = data.nickname || '';
                    document.getElementById('zodiacSign').value = data.zodiacSign || '';
                    
                    // 格式化註冊時間
                    if (data.createdAt) {
                        const createdDate = new Date(data.createdAt);
                        document.getElementById('createdAt').value = createdDate.toLocaleString('zh-TW');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // 顯示錯誤訊息
                    document.getElementById('errorText').textContent = '獲取用戶資料失敗，請稍後再試。';
                    document.getElementById('errorMessage').classList.remove('d-none');
                });
            }
            
            // 更新用戶資料
            const profileForm = document.getElementById('profileForm');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            
            profileForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 從localStorage獲取JWT令牌
                const token = localStorage.getItem('token');
                
                if (!token) {
                    // 未登入，重定向到登入頁面
                    window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                // 獲取表單數據
                const formData = {
                    email: document.getElementById('email').value,
                    nickname: document.getElementById('nickname').value,
                    zodiacSign: document.getElementById('zodiacSign').value
                };
                
                // 發送更新請求
                fetch('/api/users/me', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.message || '更新用戶資料失敗');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // 顯示成功訊息
                    document.getElementById('successText').textContent = '個人資料更新成功！';
                    successMessage.classList.remove('d-none');
                    errorMessage.classList.add('d-none');
                    
                    // 3秒後隱藏成功訊息
                    setTimeout(() => {
                        successMessage.classList.add('d-none');
                    }, 3000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    // 顯示錯誤訊息
                    document.getElementById('errorText').textContent = error.message;
                    errorMessage.classList.remove('d-none');
                    successMessage.classList.add('d-none');
                });
            });
            
            // 密碼可見性切換函數
            function setupPasswordToggle(toggleId, passwordId) {
                const toggleButton = document.getElementById(toggleId);
                const passwordInput = document.getElementById(passwordId);
                
                toggleButton.addEventListener('click', function() {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    
                    // 切換眼睛圖標
                    this.querySelector('i').classList.toggle('bi-eye');
                    this.querySelector('i').classList.toggle('bi-eye-slash');
                });
            }
            
            // 設置密碼可見性切換
            setupPasswordToggle('toggleCurrentPassword', 'currentPassword');
            setupPasswordToggle('toggleNewPassword', 'newPassword');
            setupPasswordToggle('toggleConfirmNewPassword', 'confirmNewPassword');
            
            // 修改密碼
            const savePasswordButton = document.getElementById('savePasswordButton');
            const passwordErrorMessage = document.getElementById('passwordErrorMessage');
            
            savePasswordButton.addEventListener('click', function() {
                // 獲取密碼表單數據
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmNewPassword = document.getElementById('confirmNewPassword').value;
                
                // 驗證新密碼是否一致
                if (newPassword !== confirmNewPassword) {
                    document.getElementById('passwordErrorText').textContent = '兩次輸入的新密碼不一致';
                    passwordErrorMessage.classList.remove('d-none');
                    return;
                }
                
                // 從localStorage獲取JWT令牌
                const token = localStorage.getItem('token');
                
                if (!token) {
                    // 未登入，重定向到登入頁面
                    window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                // 發送修改密碼請求
                fetch('/api/users/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.message || '密碼修改失敗');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // 密碼修改成功，關閉模態框並顯示成功訊息
                    const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                    modal.hide();
                    
                    // 清空密碼表單
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmNewPassword').value = '';
                    
                    // 顯示成功訊息
                    document.getElementById('successText').textContent = '密碼修改成功！請使用新密碼登入。';
                    successMessage.classList.remove('d-none');
                    errorMessage.classList.add('d-none');
                    
                    // 3秒後隱藏成功訊息
                    setTimeout(() => {
                        successMessage.classList.add('d-none');
                    }, 3000);
                    
                    // 清除令牌，要求用戶重新登入
                    setTimeout(() => {
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        localStorage.removeItem('tokenExpiry');
                        window.location.href = '/login?message=password_changed';
                    }, 3000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    // 顯示錯誤訊息
                    document.getElementById('passwordErrorText').textContent = error.message;
                    passwordErrorMessage.classList.remove('d-none');
                });
            });
            
            // 頁面加載時獲取用戶資料
            loadUserProfile();
        });
    </script>
</body>
</html>